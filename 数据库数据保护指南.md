# 数据库数据保护指南

**版本**: v1.1.0  
**创建日期**: 2026-02-19  
**最后更新**: 2026-02-19  
**适用项目**: Personal Blog

---

## 一、问题回顾

### 1.1 发生了什么
- 数据库表结构不完整（只创建了4张表，缺失7张表）
- 表中数据为空（所有数据丢失）
- 需要手动重建表结构和重新导入数据

### 1.2 根本原因
| 原因 | 说明 |
|------|------|
| MySQL容器重建 | Docker容器被删除后重新创建，数据卷可能被清理 |
| 缺少数据持久化策略 | 没有定期备份机制 |
| 初始化脚本未执行 | `docker-entrypoint-initdb.d` 只在容器首次启动时执行 |

### 1.3 新发现的问题 (2026-02-19)

#### 问题1：Java版本不兼容
- **现象**: 后端启动失败，报错 `UnsupportedClassVersionError`
- **原因**: 项目需要 Java 17，但系统默认 Java 是 Java 8
- **解决**: 启动脚本已添加 Java 17 环境变量设置

#### 问题2：数据库列名不匹配
- **现象**: SQL语法错误 `Unknown column 'ss1_0.key' in 'field list'`
- **原因**: 数据库表 `system_setting` 列名是 `key_name`，但实体类定义是 `key`
- **解决**: 修改数据库列名为 `key`

#### 问题3：外键约束冲突
- **现象**: 插入数据时报错 `foreign key constraint fails`
- **原因**: 旧数据与新数据存在外键冲突
- **解决**: 清空所有表数据后重新初始化

---

## 二、已创建的工具脚本

为方便数据保护和问题修复，已创建以下脚本：

| 脚本文件 | 用途 | 使用方式 |
|----------|------|----------|
| `backup-database.ps1` | 数据库备份 | 双击运行或 PowerShell 执行 |
| `restore-database.ps1` | 数据库恢复 | 双击运行或 PowerShell 执行 |
| `fix-all.ps1` | 一键修复所有问题 | 双击运行或 PowerShell 执行 |

---

## 二点五、快速修复指南

### 遇到问题时的处理流程

```
问题发生 → 运行 fix-all.ps1 → 重启后端 → 验证登录
```

### 一键修复命令
```powershell
# 在项目根目录执行
.\fix-all.ps1
```

### 修复脚本会自动处理
1. ✅ 检查 MySQL 连接
2. ✅ 修复数据库表结构（system_setting 列名）
3. ✅ 清空旧数据（避免外键冲突）
4. ✅ 验证修复结果

### 修复后重启
```powershell
# 方式1: 使用启动脚本
.\code\start.ps1

# 方式2: 手动启动后端
$env:JAVA_HOME = "C:\Users\Administrator\jdk17\jdk-17.0.18+8"
$env:PATH = "$env:JAVA_HOME\bin;$env:PATH"
java -jar code\backend\target\personal-blog-backend-1.0.0.jar --spring.profiles.active=dev
```

---

## 三、数据保护措施

### 3.1 日常操作规范

#### ✅ 正确的停止/启动方式
```powershell
# 停止MySQL（保留数据）
docker stop mysql

# 启动MySQL
docker start mysql

# 查看容器状态
docker ps -a
```

#### ❌ 危险操作（会导致数据丢失）
```powershell
# 不要删除容器！
docker rm mysql

# 不要使用 -v 参数，这会删除数据卷
docker-compose down -v

# 不要随意删除卷
docker volume rm deploy_mysql_data
```

### 3.2 定期备份策略

#### 快速备份（推荐）
```powershell
# 在项目根目录执行
.\backup-database.ps1
```

#### 快速恢复（推荐）
```powershell
# 在项目根目录执行
.\restore-database.ps1
```

#### 自动备份脚本
创建文件 `backup-database.ps1`：

```powershell
# 数据库备份脚本
$backupDir = "D:\trae\personal blog\backups"
$date = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
$backupFile = "$backupDir\blog_backup_$date.sql"

# 创建备份目录
if (!(Test-Path $backupDir)) {
    New-Item -ItemType Directory -Path $backupDir
}

# 执行备份
Write-Host "正在备份数据库..." -ForegroundColor Yellow
mysqldump -h localhost -P 13306 -u root -proot123456 blog > $backupFile

if ($LASTEXITCODE -eq 0) {
    Write-Host "备份成功: $backupFile" -ForegroundColor Green
    
    # 保留最近10个备份，删除旧的
    Get-ChildItem $backupDir -Filter "blog_backup_*.sql" | 
        Sort-Object CreationTime -Descending | 
        Select-Object -Skip 10 | 
        Remove-Item -Force
} else {
    Write-Host "备份失败！" -ForegroundColor Red
}
```

#### 手动备份命令
```powershell
# 完整备份
mysqldump -h localhost -P 13306 -u root -proot123456 blog > blog_backup_$(Get-Date -Format 'yyyyMMdd').sql

# 仅备份表结构
mysqldump -h localhost -P 13306 -u root -proot123456 --no-data blog > blog_schema_backup.sql

# 仅备份数据（不含表结构）
mysqldump -h localhost -P 13306 -u root -proot123456 --no-create-info blog > blog_data_backup.sql
```

#### 数据恢复命令
```powershell
# 恢复数据
mysql -h localhost -P 13306 -u root -proot123456 blog < blog_backup_xxxx.sql
```

### 3.3 启动脚本增强

修改 `start.ps1`，添加数据检查功能：

```powershell
# 在启动前检查数据库表完整性
Write-Host "[2.5/5] Checking database tables..." -ForegroundColor Yellow

$tablesCheck = mysql -h localhost -P 13306 -u root -proot123456 -e "
    SELECT COUNT(*) FROM information_schema.tables 
    WHERE table_schema = 'blog'
" 2>$null

if ($LASTEXITCODE -ne 0 -or $tablesCheck -lt 11) {
    Write-Host "      Warning: Database tables may be incomplete!" -ForegroundColor Yellow
    Write-Host "      Run: .\restore-database.ps1" -ForegroundColor Cyan
}
```

### 3.4 创建数据恢复脚本

创建文件 `restore-database.ps1`：

```powershell
# 数据库恢复脚本
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "   Database Restore Tool" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# 检查MySQL连接
try {
    $result = mysql -h localhost -P 13306 -u root -proot123456 -e "SELECT 1" 2>&1
    if ($LASTEXITCODE -ne 0) {
        throw "Connection failed"
    }
    Write-Host "MySQL连接正常" -ForegroundColor Green
} catch {
    Write-Host "[ERROR] 无法连接到MySQL" -ForegroundColor Red
    Write-Host "请确保MySQL容器正在运行: docker start mysql" -ForegroundColor Yellow
    exit 1
}

# 列出可用的备份
$backupDir = "D:\trae\personal blog\backups"
if (Test-Path $backupDir) {
    $backups = Get-ChildItem $backupDir -Filter "blog_backup_*.sql" | Sort-Object CreationTime -Descending
    
    if ($backups.Count -eq 0) {
        Write-Host "未找到备份文件，将使用初始数据..." -ForegroundColor Yellow
        # 执行初始数据导入
        Get-Content sql\init-data-ascii.sql | mysql -h localhost -P 13306 -u root -proot123456 blog
    } else {
        Write-Host "可用的备份文件:" -ForegroundColor Cyan
        for ($i = 0; $i -lt $backups.Count; $i++) {
            Write-Host "  [$i] $($backups[$i].Name) - $($backups[$i].CreationTime)"
        }
        
        $choice = Read-Host "请选择要恢复的备份编号 (或输入 'init' 使用初始数据)"
        
        if ($choice -eq 'init') {
            Get-Content sql\init-data-ascii.sql | mysql -h localhost -P 13306 -u root -proot123456 blog
        } else {
            $selectedBackup = $backups[[int]$choice].FullName
            Write-Host "正在恢复: $selectedBackup" -ForegroundColor Yellow
            mysql -h localhost -P 13306 -u root -proot123456 blog < $selectedBackup
        }
    }
} else {
    Write-Host "备份目录不存在，使用初始数据..." -ForegroundColor Yellow
    Get-Content sql\init-data-ascii.sql | mysql -h localhost -P 13306 -u root -proot123456 blog
}

Write-Host ""
Write-Host "恢复完成！" -ForegroundColor Green
```

---

## 四、项目启动流程（更新版）

### 4.1 完整启动步骤

```powershell
# 1. 启动MySQL容器（如果未运行）
docker start mysql

# 2. 等待MySQL就绪（约5秒）
Start-Sleep 5

# 3. 检查数据库完整性（可选）
mysql -h localhost -P 13306 -u root -proot123456 -e "SHOW TABLES;" blog

# 4. 启动项目
.\code\start.ps1
```

### 4.2 推荐的工作流程

| 场景 | 操作 |
|------|------|
| 日常开发 | 直接运行 `start.ps1` |
| 长时间未使用 | 先 `docker start mysql`，再运行 `start.ps1` |
| 数据异常 | 运行 `restore-database.ps1` 恢复数据 |
| 重大更新前 | 运行 `backup-database.ps1` 备份数据 |

---

## 五、数据保护检查清单

### 5.1 每次启动前检查
- [ ] MySQL容器状态: `docker ps | findstr mysql`
- [ ] 数据库连接正常
- [ ] 表数量正确（11张表）

### 5.2 每周维护任务
- [ ] 执行一次数据库备份
- [ ] 检查备份文件是否正常生成
- [ ] 清理超过10个的旧备份

### 5.3 每月维护任务
- [ ] 验证备份文件可恢复性
- [ ] 检查Docker卷使用情况: `docker volume ls`
- [ ] 检查磁盘空间

---

## 六、紧急情况处理

### 6.1 数据丢失后的恢复步骤

1. **不要 panic** - 先检查是否有备份
2. **查找备份文件**
   ```powershell
   ls D:\trae\personal blog\backups\blog_backup_*.sql
   ```
3. **执行恢复**
   ```powershell
   .\restore-database.ps1
   ```
4. **验证恢复结果**
   ```powershell
   mysql -h localhost -P 13306 -u root -proot123456 -e "SHOW TABLES; SELECT COUNT(*) FROM admin;" blog
   ```

### 5.2 联系支持

如果以上步骤无法解决问题：
1. 查看错误日志
2. 检查Docker容器日志: `docker logs mysql`
3. 检查后端日志: `code\backend\logs\`

---

## 六、附录

### 7.1 数据库表清单

| 表名 | 说明 | 重要程度 |
|------|------|----------|
| admin | 管理员账户 | ⭐⭐⭐ 高 |
| category | 文章分类 | ⭐⭐⭐ 高 |
| tag | 文章标签 | ⭐⭐⭐ 高 |
| article | 文章数据 | ⭐⭐⭐ 高 |
| article_tag | 文章标签关联 | ⭐⭐ 中 |
| image | 图片数据 | ⭐⭐ 中 |
| city | 城市数据 | ⭐⭐ 中 |
| music | 音乐数据 | ⭐⭐ 中 |
| system_setting | 系统设置 | ⭐⭐ 中 |
| visit_stat | 访问统计 | ⭐ 低 |
| inspiration | 灵感记录 | ⭐ 低 |

### 7.2 关键配置文件

| 文件 | 作用 |
|------|------|
| `deploy/docker-compose.yml` | Docker配置，包含MySQL卷映射 |
| `sql/schema.sql` | 数据库表结构 |
| `sql/init-data.sql` | 初始数据（中文） |
| `sql/init-data-ascii.sql` | 初始数据（英文，避免编码问题） |

---

**最后更新**: 2026-02-19  
**维护者**: 开发团队
